##
# Main Site Server Block (Will be main landing page)
##

# Check user input
map $cookie_theme $theme {
  "Default"     "default";
  "Open Orbis"  "openorbis";
  default       "default";
}

server {
  charset utf-8;
  chunked_transfer_encoding on;

  include error.conf;
  error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 @error_html;

  listen 0.0.0.0:80;
  listen 0.0.0.0:443 ssl http2;
  #{{IPV6}} listen [::]:80;
  #{{IPV6}} listen [::]:443 ssl http2;
  server_name {{ROOT_DOMAIN}};

  # TLS Config
  #{{LETSENCRYPT}} ssl_certificate /etc/letsencrypt/live/{{ROOT_DOMAIN}}/fullchain.pem;
  #{{LETSENCRYPT}} ssl_certificate_key /etc/letsencrypt/live/{{ROOT_DOMAIN}}/privkey.pem;
  #{{LETSENCRYPT}} ssl_trusted_certificate /etc/letsencrypt/live/{{ROOT_DOMAIN}}/chain.pem;

  #{{SELF}} ssl_certificate /etc/nginx/certs/snakeoil.crt;
  #{{SELF}} ssl_certificate_key /etc/nginx/certs/private/snakeoil.key;

  #{{MOUNT}} ssl_certificate /etc/nginx/certs/fullchain.pem;
  #{{MOUNT}} ssl_certificate_key /etc/nginx/certs/private/privkey.pem;
  #{{MOUNT}} ssl_trusted_certificate /etc/nginx/certs/chain.pem;

  #{{CF_STRICT}} ssl_client_certificate /etc/nginx/certs/origin-pull-ca.pem;
  #{{CF_STRICT}} ssl_verify_client on;

  ##
  # OCSP Stapling
  ##

  #{{OCSP_STAPLING}} ssl_stapling on;
  #{{OCSP_STAPLING}} ssl_stapling_verify on;
  #{{OCSP_STAPLING}} resolver 1.1.1.1 1.0.0.1 [2606:4700:4700::1111] [2606:4700:4700::1001] valid=60s;
  #{{OCSP_STAPLING}} resolver_timeout 2s;

  root /var/www;

  location = /api/themes {
    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 @error_json;
    more_set_headers "Content-Type application/json";
    return 200 "{\"themes\":[\"Default\"]}";
  }

  location = /api/menu {
    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 @error_json;
    more_set_headers "Content-Type application/json";
    alias /var/www/menu.json;
  }

  location = /api/news {
    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 @error_json;
    more_set_headers "Content-Type application/json";
    alias /var/www/news.json;
  }

  location ^~ /exploits/ {
    autoindex on;
    autoindex_exact_size on;
    autoindex_format html;
    autoindex_localtime off;
    index hidden.html;

    try_files $uri $uri/ =404;
  }

  location ^~ /cache/ {
    try_files $uri $uri/ =404;
  }

  location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)$ {
    root /var/www/themes/$theme;
    expires 1M;
    add_header Cache-Control "public";
  }

  location ~* \.(?:css|js)$ {
    root /var/www/themes/$theme;
    expires 1y;
    add_header Cache-Control "public";
  }

  location / {
    # add_header Cache-Control no-store;
    root /var/www/themes/$theme;
    autoindex off;
    index index.html;

    try_files $uri $uri/ =404;
  }

  include general.conf;
}

# Dump any requests that are not accounted for
server {
  listen 0.0.0.0:80 default_server;
  listen 0.0.0.0:443 ssl http2 default_server;
  #{{IPV6}} listen [::]:80 default_server;
  #{{IPV6}} listen [::]:443 ssl http2 default_server;

  ssl_certificate /etc/nginx/certs/snakeoil.crt;
  ssl_certificate_key /etc/nginx/certs/private/snakeoil.key;

  access_log off;
  error_log /dev/null;

  return 444;
}
