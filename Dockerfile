FROM alpine:3.18.4

RUN \
    # Update and install system applications
    apk add --update --no-cache \
        bind-tools=9.18.19-r0 \
        certbot=2.6.0-r0 \
        curl=8.4.0-r0 \
        libcap=2.69-r0 \
        lua-resty-core=0.1.26-r0 \
        nginx=1.24.0-r7 \
        nginx-mod-http-fancyindex=1.24.0-r7 \
        nginx-mod-http-headers-more=1.24.0-r7 \
        nginx-mod-http-lua=1.24.0-r7 \
        openssl=3.1.4-r0 \
        shadow=4.13-r4 \
        tini=0.19.0-r1 && \
    # Remove default NGINX vHosts and website
    rm -f /etc/nginx/sites-enabled/default && \
    rm -f /etc/nginx/sites-available/default && \
    rm -rf /var/www/html && \
    # Setup templates directory
    mkdir -m 755 -p /etc/nginx/templates/sites-available && \
    # Setup enabled vHost directory
    mkdir -m 755 -p /etc/nginx/sites-enabled && \
    # Setup enabled modules directory
    mkdir -m 755 -p /etc/nginx/modules-enabled && \
    # Setup folders for certs
    mkdir 0m 710 -p /etc/nginx/certs/private && \
    chmod 755 /etc/nginx/certs && \
    # Setup logging directory
    mkdir -p /var/log/docker && \
    # Allown nginx to use privileged ports without root
    setcap 'cap_net_bind_service=+ep' /usr/sbin/nginx && \
    # Change nginx user's uid/gid
    groupmod -g 10001 nginx && \
    usermod -u 10000 nginx

# Copy NGINX global settings to container
COPY nginx/nginx.conf /etc/nginx/templates/
COPY nginx/general.conf /etc/nginx/templates/
COPY nginx/error.conf /etc/nginx/templates/

# Copy NGINX vHosts to container
COPY nginx/vhosts* /etc/nginx/templates/sites-available/

# Copy entrypoint script to container
COPY entrypoint.sh /entrypoint.sh

# Copy "static" files
COPY ps-sys-updates /var/www/ps-sys-updates

# Set permissions on copied files
RUN \
    mkdir -p \
        /var/www/cache \
        /var/www/exploits \
        /var/www/themes/default && \
    touch \
        /var/www/menu.json \
        /var/www/news.json \
        /var/www/themes/default/index.html && \
    chmod -R 644 \
        /etc/nginx/templates/nginx.conf \
        /etc/nginx/templates/general.conf \
        /etc/nginx/templates/error.conf \
        /etc/nginx/templates/sites-available/* \
        /var/www/* && \
    rm -rf \
        /var/www/ps-sys-updates/readme.txt \
        /var/www/localhost && \
    chmod +x /entrypoint.sh

# Open HTTP(S) ports
EXPOSE 80/tcp 443/tcp

# Start entrypoint script
ENTRYPOINT ["/sbin/tini", "--", "/entrypoint.sh", "/usr/sbin/nginx"]

# Set default command for container
CMD ["-g", "daemon off;"]
