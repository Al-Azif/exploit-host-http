FROM alpine:3.16.2

RUN \
    # Update and install system applications
    apk add --update --no-cache \
        certbot=1.27.0-r0 \
        curl=7.83.1-r3 \
        lua-resty-core=0.1.23-r0 \
        nginx=1.22.0-r1 \
        nginx-mod-http-fancyindex=1.22.0-r1 \
        nginx-mod-http-headers-more=1.22.0-r1 \
        nginx-mod-http-lua=1.22.0-r1 \
        openssl=1.1.1q-r0 \
        tini=0.19.0-r0 && \
    # Remove default NGINX vHosts and website
    rm -f /etc/nginx/sites-enabled/default && \
    rm -f /etc/nginx/sites-available/default && \
    rm -rf /var/www/html && \
    # Setup templates directory
    mkdir -p /etc/nginx/templates/sites-available && \
    chmod 755 /etc/nginx/templates && \
    chmod 755 /etc/nginx/templates/sites-available && \
    # Setup enabled vHost directory
    mkdir -p /etc/nginx/sites-enabled && \
    chmod 755 /etc/nginx/sites-enabled && \
    # Setup enabled modules directory
    mkdir -p /etc/nginx/modules-enabled && \
    chmod 755 /etc/nginx/modules-enabled && \
    # Setup folders for certs
    mkdir -p /etc/nginx/certs/private && \
    chmod 755 /etc/nginx/certs && \
    chmod 710 /etc/nginx/certs/private && \
    # Setup logging directory
    mkdir -p /var/log/docker

# Copy NGINX global settings to container
COPY nginx/nginx.conf /etc/nginx/templates/
COPY nginx/general.conf /etc/nginx/templates/
COPY nginx/error.conf /etc/nginx/templates/

# Copy NGINX vHosts to container
COPY nginx/vhosts* /etc/nginx/templates/sites-available/

# Copy entrypoint script to container
COPY entrypoint.sh /entrypoint.sh

# Set permissions on copied files
RUN \
    chmod 644 \
        /etc/nginx/templates/nginx.conf \
        /etc/nginx/templates/general.conf \
        /etc/nginx/templates/error.conf \
        /etc/nginx/templates/sites-available/* && \
    chmod +x /entrypoint.sh

# Open HTTP(S) ports
EXPOSE 80/tcp 443/tcp

# Start entrypoint script
ENTRYPOINT ["/sbin/tini", "--", "/entrypoint.sh"]

# Set default command for container
CMD ["nginx", "-g", "daemon off;"]
